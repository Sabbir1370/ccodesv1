// src/detectors/VulnerabilityDetector.hpp - FIXED
#ifndef VULNERABILITY_DETECTOR_HPP
#define VULNERABILITY_DETECTOR_HPP

#include <memory>
#include <vector>
#include <string>
#include "Finding.hpp"

// Forward declarations in GLOBAL namespace
class ASTNode;
class SymbolTable;
class CFG; // CFG is in global namespace, NOT in cfg namespace

namespace detectors
{
    struct DetectorConfig
    {
        bool enabled = true;
        Severity severity_override;
        int risk_weight = 1;

        DetectorConfig() : enabled(true), severity_override(Severity::MEDIUM) {}
    };

    class VulnerabilityDetector
    {
    protected:
        DetectorConfig config_;
        std::string rule_id_;
        std::string description_;

    public:
        VulnerabilityDetector(const std::string &rule_id, const std::string &description)
            : rule_id_(rule_id), description_(description) {}

        virtual ~VulnerabilityDetector() = default;

        virtual std::vector<Finding> analyze(
            std::shared_ptr<ASTNode> ast,
            SymbolTable *symtab,
            const std::vector<std::shared_ptr<CFG>> &cfgs) = 0; // CFG, not cfg::CFG

        virtual std::string getName() const { return rule_id_; }
        virtual std::string getDescription() const { return description_; }
        virtual bool isEnabled() const { return config_.enabled; }
        virtual void setEnabled(bool enabled) { config_.enabled = enabled; }
        virtual DetectorConfig getConfig() const { return config_; }
        virtual void setConfig(const DetectorConfig &config) { config_ = config; }

        Finding createBaseFinding(
            const SourceLocation &location,
            Severity severity,
            const std::string &specific_desc = "") const
        {
            std::string full_desc = description_;
            if (!specific_desc.empty())
            {
                full_desc += ": " + specific_desc;
            }

            Finding finding(rule_id_, full_desc, location, severity);
            return finding;
        }
    };
} // namespace detectors

#endif // VULNERABILITY_DETECTOR_HPP